From ac7a42f23139f53a6089c3cf0421ee9da4d41c99 Mon Sep 17 00:00:00 2001
From: radium88 <ahamod3.1416@gmail.com>
Date: Wed, 26 Feb 2025 19:16:51 +0100
Subject: [PATCH] add custom boot command and modify environment variable

Signed-off-by: radium88 <ahamod3.1416@gmail.com>
---
 include/configs/stm32mp15_common.h    | 49 ++++++++++++++++++++-------
 include/configs/stm32mp15_st_common.h |  3 +-
 2 files changed, 39 insertions(+), 13 deletions(-)

diff --git a/include/configs/stm32mp15_common.h b/include/configs/stm32mp15_common.h
index 58971cc656..05048f4408 100644
--- a/include/configs/stm32mp15_common.h
+++ b/include/configs/stm32mp15_common.h
@@ -118,18 +118,7 @@
  * for nor boot, use the default distro order in ${boot_targets}
  */
 #define STM32MP_BOOTCMD "bootcmd_stm32mp=" \
-	"echo \"Boot over ${boot_device}${boot_instance}!\";" \
-	"if test ${boot_device} = serial || test ${boot_device} = usb;" \
-	"then stm32prog ${boot_device} ${boot_instance}; " \
-	"else " \
-		"run env_check;" \
-		"if test ${boot_device} = mmc;" \
-		"then env set boot_targets \"mmc${boot_instance}\"; fi;" \
-		"if test ${boot_device} = nand ||" \
-		  " test ${boot_device} = spi-nand ;" \
-		"then env set boot_targets ubifs0; fi;" \
-		"run distro_bootcmd;" \
-	"fi;\0"
+	"run emmc_boot;\0"
 
 #ifdef CONFIG_FASTBOOT_CMD_OEM_FORMAT
 /* eMMC default partitions for fastboot command: oem format */
@@ -154,6 +143,32 @@
 
 #include <config_distro_bootcmd.h>
 
+#define SD_BOOT \
+	"sd_boot=ext4load mmc 0:7 ${kernel_addr_r} ${image.linux};" \
+	"setenv bootargs \"console=${console},115200 root=/dev/mmcblk0p8 rw rootwait loglevel=7\";" \
+	"bootm ${kernel_addr_r}#conf-stm32mp157c-emsbc-argon.dtb\0"
+
+#define EMMC_BOOT \
+	"emmc_boot=ext4load mmc 1:7 ${kernel_addr_r} ${image.linux};" \
+	"setenv bootargs \"console=${console},115200 root=/dev/mmcblk1p8 rw rootwait loglevel=7\";" \
+	"bootm ${kernel_addr_r}#conf-stm32mp157c-emsbc-argon.dtb\0"
+
+#define CONFIGURE_IP \
+	"configure-ip=if test -n \"${ip-method}\"; \
+	then if test \"${ip-method}\" = dhcp; \
+	then setenv ip dhcp && setenv autoload no && dhcp ; \
+	elif test \"${ip-method}\" = static; \
+	then if test -n \"${ipaddr}\" && test -n \"${serverip}\" && test -n \"${netmask}\"; \
+	then setenv ip ${ipaddr}:${serverip}:${gatewayip}:${netmask}:${hostname}:eth0:off; \
+	else echo You have to set ipaddr, netmask and serverip when using ip-method static. ;  false; fi; \
+	else echo ip-method has to be either dhcp or static. ; false ; fi; else echo ip-method has to be either dhcp or static. ; false ; fi\0"
+
+#define NET_BOOT \
+	"net_boot=run configure-ip;" \
+	"nfs ${kernel_addr_r} ${nfsroot}/boot/${image.linux};" \
+	"setenv bootargs \"root=/dev/nfs nfsroot=${serverip}:${nfsroot},nfsvers=3 ip=dhcp rootwait rw\";" \
+	"bootm ${kernel_addr_r}#conf-stm32mp157c-emsbc-argon.dtb\0"
+
 /*
  * memory layout for 32M uncompressed/compressed kernel,
  * 1M fdt, 1M script, 1M pxe and 1M for overlay
@@ -175,11 +190,21 @@
 	"ramdisk_addr_r=" __RAMDISK_ADDR_R "\0"
 
 #define CONFIG_EXTRA_ENV_SETTINGS \
+	"stdin=serial\0" \
+	"stdout=serial\0" \
+	"stderr=serial\0" \
+	"bootdelay=" __stringify(CONFIG_BOOTDELAY) "\0" \
+	"ip-method=dhcp\0" \
+	"image.linux=fitImage\0" \
 	STM32MP_MEM_LAYOUT \
 	STM32MP_BOOTCMD \
 	STM32MP_PARTS_DEFAULT \
 	BOOTENV \
+	SD_BOOT \
+	NET_BOOT \
+	EMMC_BOOT \
 	STM32MP_EXTRA \
+	CONFIGURE_IP \
 	STM32MP_BOARD_EXTRA_ENV
 
 #endif /* ifndef CONFIG_SPL_BUILD */
diff --git a/include/configs/stm32mp15_st_common.h b/include/configs/stm32mp15_st_common.h
index c395f7f986..36c292f68e 100644
--- a/include/configs/stm32mp15_st_common.h
+++ b/include/configs/stm32mp15_st_common.h
@@ -19,7 +19,8 @@
 					 230400, 460800, 921600, \
 					 1000000, 2000000 }
 
-#ifdef CONFIG_EXTRA_ENV_SETTINGS
+/* #ifdef CONFIG_EXTRA_ENV_SETTINGS */
+#if 0
 /*
  * default bootcmd for stm32mp1 STMicroelectronics boards:
  * for serial/usb: execute the stm32prog command
-- 
2.34.1

